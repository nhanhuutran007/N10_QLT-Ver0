<Window x:Class="QLKDPhongTro.Presentation.Views.Windows.ScanImageView"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        Title="Thêm ảnh để quét"
        Height="700"
        Width="900"
        WindowStyle="None"
        AllowsTransparency="True"
        Background="Transparent"
        WindowStartupLocation="CenterScreen"
        FontFamily="Roboto">

    <Window.Resources>
        <!-- Style cho nút Gửi -->
        <Style TargetType="{x:Type Button}"
                x:Key="SubmitButtonStyle">
            <Setter Property="Background"
                    Value="#319DFF"/>
            <Setter Property="Foreground"
                    Value="White"/>
            <Setter Property="FontSize"
                    Value="14"/>
            <Setter Property="FontWeight"
                    Value="Medium"/>
            <Setter Property="BorderThickness"
                    Value="0"/>
            <Setter Property="Cursor"
                    Value="Hand"/>
            <Setter Property="Height"
                    Value="40"/>
            <Setter Property="Width"
                    Value="80"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="{x:Type Button}">
                        <Border CornerRadius="6"
                                Background="{TemplateBinding Background}">
                            <ContentPresenter HorizontalAlignment="Center"
                                    VerticalAlignment="Center"/>
                        </Border>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
            <Style.Triggers>
                <Trigger Property="IsMouseOver"
                        Value="True">
                    <Setter Property="Background"
                            Value="#1A8CFF"/>
                </Trigger>
            </Style.Triggers>
        </Style>

        <!-- Style cho nút đóng (X) -->
        <Style TargetType="{x:Type Button}"
                x:Key="CloseButtonStyle">
            <Setter Property="Background"
                    Value="Transparent"/>
            <Setter Property="BorderThickness"
                    Value="0"/>
            <Setter Property="Cursor"
                    Value="Hand"/>
            <Setter Property="Foreground"
                    Value="#586A84"/>
            <Setter Property="FontSize"
                    Value="16"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="{x:Type Button}">
                        <Border Background="{TemplateBinding Background}"
                                CornerRadius="16">
                            <ContentPresenter HorizontalAlignment="Center"
                                    VerticalAlignment="Center"/>
                        </Border>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
            <Style.Triggers>
                <Trigger Property="IsMouseOver"
                        Value="True">
                    <Setter Property="Background"
                            Value="#F0F0F0"/>
                </Trigger>
            </Style.Triggers>
        </Style>
    </Window.Resources>

    <!-- Border chính chứa nội dung và hiệu ứng đổ bóng -->
    <Border Background="White"
            CornerRadius="12"
            Margin="10">
        <Border.Effect>
            <DropShadowEffect Color="#A9A8B6"
                    Opacity="0.15"
                    ShadowDepth="4"
                    BlurRadius="20"/>
        </Border.Effect>

        <Grid>
            <Grid.RowDefinitions>
                <RowDefinition Height="Auto"/>
                <!-- Hàng cho tiêu đề -->
                <RowDefinition Height="Auto"/>
                <!-- Hàng cho chọn loại chỉ số -->
                <RowDefinition Height="*"/>
                <!-- Hàng cho nội dung chính -->
                <RowDefinition Height="Auto"/>
                <!-- Hàng cho kết quả -->
                <RowDefinition Height="Auto"/>
                <!-- Hàng cho nút -->
            </Grid.RowDefinitions>

            <!-- === TIÊU ĐỀ === -->
            <Grid Grid.Row="0"
                    Margin="24,16,16,16">
                <TextBlock Text="Thêm ảnh để quét"
                           Foreground="#3B4758"
                           FontSize="18"
                           FontWeight="Medium"
                           VerticalAlignment="Center"/>
                <Button Grid.Column="1"
                        Content="✕"
                        Style="{StaticResource CloseButtonStyle}"
                        HorizontalAlignment="Right"
                        VerticalAlignment="Center"
                        Width="32"
                        Height="32"
                        Click="CloseButton_Click"/>
            </Grid>

            <!-- === CHỌN LOẠI CHỈ SỐ === -->
            <StackPanel Grid.Row="1" Margin="24,0,24,16" Orientation="Horizontal">
                <TextBlock Text="Loại chỉ số:" 
                           Foreground="#3B4758"
                           FontSize="14"
                           VerticalAlignment="Center"
                           Margin="0,0,10,0"/>
                <RadioButton Content="Chỉ số điện" 
                             IsChecked="True"
                             GroupName="MeterType"
                             Checked="ElectricityRadio_Checked"
                             Margin="0,0,20,0"/>
                <RadioButton Content="Chỉ số nước"
                             GroupName="MeterType"
                             Checked="WaterRadio_Checked"/>
            </StackPanel>

            <!-- === NỘI DUNG CHÍNH (VÙNG KÉO-THẢ) === -->
            <StackPanel Grid.Row="2"
                    Margin="24,0">
                <TextBlock Text="Đọc số từ ảnh để tính toán chi phí"
                           Foreground="#3B4758"
                           FontSize="16"
                           FontWeight="Bold"
                           Margin="0,0,0,16"/>

                <!-- Vùng kéo-thả tệp -->
                <Grid x:Name="DropZone"
                      Height="130"
                      AllowDrop="True"
                      Drop="DropZone_Drop"
                      DragEnter="DropZone_DragEnter"
                      MouseLeftButtonDown="DropZone_MouseLeftButtonDown"
                      Background="#F7F8FA"
                      Cursor="Hand">

                    <!-- LỚP VẼ VIỀN NÉT ĐỨT (SỬA LỖI TẠI ĐÂY) -->
                    <Rectangle Stroke="#319DFF"
                               StrokeThickness="1"
                               RadiusX="6"
                               RadiusY="6"
                               StrokeDashArray="4 4"/>

                    <!-- Lớp nội dung (icon và text) -->
                    <StackPanel HorizontalAlignment="Center"
                            VerticalAlignment="Center"
                            IsHitTestVisible="False">
                        <!-- Icon đám mây (sử dụng Path từ SVG) -->
                        <Path Data="M316 187C312.967 187 310.375 185.95 308.226 183.85C306.075 181.75 305 179.183 305 176.15C305 173.55 305.783 171.233 307.35 169.2C308.917 167.167 310.967 165.867 313.5 165.3C314.333 162.233 316 159.75 318.5 157.85C321 155.95 323.833 155 327 155C330.9 155 334.208 156.358 336.924 159.074C339.641 161.791 341 165.1 341 169C343.3 169.267 345.209 170.258 346.726 171.974C348.242 173.691 349 175.7 349 178C349 180.5 348.125 182.625 346.376 184.376C344.625 186.125 342.5 187 340 187H329V172.7L330.8 174.45C331.167 174.817 331.625 175 332.176 175C332.725 175 333.2 174.8 333.6 174.4C333.967 174.033 334.15 173.567 334.15 173C334.15 172.433 333.967 171.967 333.6 171.6L328.4 166.4C328 166 327.533 165.8 327 165.8C326.467 165.8 326 166 325.6 166.4L320.4 171.6C320.033 171.967 319.842 172.425 319.826 172.974C319.809 173.525 320 174 320.4 174.4C320.767 174.767 321.225 174.959 321.774 174.976C322.325 174.992 322.8 174.817 323.2 174.45L325 172.7V187H316Z"
                              Fill="#319DFF"
                                Width="48"
                                Height="48"
                                Stretch="Uniform"
                                Margin="0,0,0,10"/>

                        <TextBlock Text="Drag and drop your files here"
                                   Foreground="#319DFF"
                                FontSize="14"/>
                        <TextBlock Text="or click to upload (up to 10 files)"
                                   Foreground="#319DFF"
                                FontSize="14"/>
                    </StackPanel>
                </Grid>
            </StackPanel>

            <!-- === KẾT QUẢ QUÉT === -->
            <ScrollViewer Grid.Row="3" 
                          VerticalScrollBarVisibility="Auto"
                          MaxHeight="300"
                          Margin="24,0,24,16"
                          Visibility="Visible">
                <ItemsControl ItemsSource="{Binding ScanResults}">
                    <ItemsControl.ItemTemplate>
                        <DataTemplate>
                            <Border Background="#F7F8FA"
                                    CornerRadius="6"
                                    Padding="12"
                                    Margin="0,0,0,8">
                                <Grid>
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="120"/>
                                        <ColumnDefinition Width="*"/>
                                        <ColumnDefinition Width="Auto"/>
                                    </Grid.ColumnDefinitions>
                                    
                                    <!-- Preview ảnh -->
                                    <Border Grid.Column="0"
                                            Background="White"
                                            BorderBrush="#E8E8E8"
                                            BorderThickness="1"
                                            CornerRadius="4"
                                            Margin="0,0,12,0"
                                            Cursor="Hand"
                                            MouseLeftButtonDown="ImagePreview_MouseLeftButtonDown">
                                        <Image Source="{Binding ImagePreview}"
                                               Stretch="Uniform"
                                               MaxHeight="100"
                                               MaxWidth="100"/>
                                    </Border>
                                    
                                    <!-- Thông tin kết quả -->
                                    <StackPanel Grid.Column="1">
                                        <TextBlock Text="{Binding ImageName}"
                                                   FontWeight="Bold"
                                                   Foreground="#3B4758"
                                                   Margin="0,0,0,4"/>
                                        
                                        <!-- Giá trị đã đọc được -->
                                        <TextBlock Text="{Binding Result.Value, StringFormat='Giá trị: {0:N2}'}"
                                                   Foreground="#586A84"
                                                   Margin="0,2,0,0"
                                                   FontWeight="Medium">
                                            <TextBlock.Style>
                                                <Style TargetType="TextBlock">
                                                    <Setter Property="Visibility" Value="Collapsed"/>
                                                    <Style.Triggers>
                                                        <DataTrigger Binding="{Binding Result.IsValid}" Value="True">
                                                            <Setter Property="Visibility" Value="Visible"/>
                                                        </DataTrigger>
                                                    </Style.Triggers>
                                                </Style>
                                            </TextBlock.Style>
                                        </TextBlock>
                                        
                                        <!-- Thông báo lỗi -->
                                        <TextBlock Text="{Binding Result.ErrorMessage}"
                                                   Foreground="#FF316A"
                                                   Margin="0,2,0,0"
                                                   TextWrapping="Wrap"
                                                   FontSize="12">
                                            <TextBlock.Style>
                                                <Style TargetType="TextBlock">
                                                    <Setter Property="Visibility" Value="Collapsed"/>
                                                    <Style.Triggers>
                                                        <DataTrigger Binding="{Binding Result.IsValid}" Value="False">
                                                            <Setter Property="Visibility" Value="Visible"/>
                                                        </DataTrigger>
                                                    </Style.Triggers>
                                                </Style>
                                            </TextBlock.Style>
                                        </TextBlock>
                                        
                                        <!-- YOLO Detection Info để debug (luôn hiển thị) -->
                                        <Expander Header="Xem thông tin detection (Debug)"
                                                  Margin="0,8,0,0"
                                                  FontSize="11">
                                            <TextBlock Text="{Binding RawOcrText}"
                                                       Foreground="#7D8FA9"
                                                       FontSize="10"
                                                       TextWrapping="Wrap"
                                                       MaxHeight="100"
                                                       Margin="0,4,0,0"/>
                                        </Expander>
                                    </StackPanel>
                                    
                                    <!-- Trạng thái -->
                                    <StackPanel Grid.Column="2"
                                                VerticalAlignment="Center"
                                                Margin="12,0,0,0">
                                        <TextBlock Text="{Binding Status}"
                                                   Foreground="{Binding StatusColor}"
                                                   FontWeight="Medium"
                                                   HorizontalAlignment="Right"/>
                                        <TextBlock Foreground="#7D8FA9"
                                                   FontSize="10"
                                                   Margin="0,4,0,0"
                                                   HorizontalAlignment="Right">
                                            <TextBlock.Text>
                                                <Binding Path="Result.Confidence" StringFormat="Độ tin cậy: {0:P0}">
                                                    <Binding.TargetNullValue>--</Binding.TargetNullValue>
                                                </Binding>
                                            </TextBlock.Text>
                                            <TextBlock.Style>
                                                <Style TargetType="TextBlock">
                                                    <Setter Property="Visibility" Value="Collapsed"/>
                                                    <Style.Triggers>
                                                        <DataTrigger Binding="{Binding Result}" Value="{x:Null}">
                                                            <Setter Property="Visibility" Value="Collapsed"/>
                                                        </DataTrigger>
                                                    </Style.Triggers>
                                                </Style>
                                            </TextBlock.Style>
                                        </TextBlock>
                                    </StackPanel>
                                </Grid>
                            </Border>
                        </DataTemplate>
                    </ItemsControl.ItemTemplate>
                </ItemsControl>
            </ScrollViewer>

            <!-- === NÚT XỬ LÝ === -->
            <StackPanel Grid.Row="4"
                        Orientation="Horizontal"
                        HorizontalAlignment="Center"
                        Margin="0,20,0,20">
                <Button Content="Quét ảnh"
                        Style="{StaticResource SubmitButtonStyle}"
                        Command="{Binding ProcessImagesCommand}"
                        IsEnabled="{Binding IsNotProcessing}"
                        Margin="0,0,10,0"/>
                <Button Content="Đóng"
                        Style="{StaticResource SubmitButtonStyle}"
                        Background="#7D8FA9"
                        Click="CloseButton_Click"
                        Margin="10,0,0,0"/>
            </StackPanel>
        </Grid>
    </Border>
</Window>