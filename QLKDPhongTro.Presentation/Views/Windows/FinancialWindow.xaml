<Window x:Class="QLKDPhongTro.Presentation.Views.Windows.FinancialWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:components="clr-namespace:QLKDPhongTro.Presentation.Views.Components"
        xmlns:local="clr-namespace:QLKDPhongTro.Presentation.Views.Windows"
        xmlns:converters="clr-namespace:QLKDPhongTro.Presentation.Converters"
        xmlns:sys="clr-namespace:System;assembly=mscorlib"
        Title="Quản lý tài chính - Quản Lý Phòng Trọ"
        MinHeight="600"
        MinWidth="800"
        Height="700"
        Width="1200"
        WindowStartupLocation="CenterScreen"
        ResizeMode="CanResize"
        Background="#F8FAFC"
        FontFamily="Segoe UI"
        Icon="/Resources/Images/Logo.png">

    <Window.Resources>
        <!-- Converters -->
        <BooleanToVisibilityConverter x:Key="BooleanToVisibilityConverter"/>
        <!-- FIX: Sử dụng MultiConverter đã sửa ở lượt trước -->
        <converters:PageNumberEqualsMultiConverter x:Key="PageNumberEqualsMultiConverter"/>


        <!-- === STYLES CẢI TIẾN HIỆN ĐẠI === -->

        <!-- Color palette hiện đại -->
        <SolidColorBrush x:Key="PrimaryColor" Color="#10B981"/>
        <SolidColorBrush x:Key="PrimaryDarkColor" Color="#059669"/>
        <SolidColorBrush x:Key="SecondaryColor" Color="#3B82F6"/>
        <SolidColorBrush x:Key="SecondaryDarkColor" Color="#2563EB"/>
        <SolidColorBrush x:Key="AccentColor" Color="#8B5CF6"/>
        <SolidColorBrush x:Key="WarningColor" Color="#F59E0B"/>
        <SolidColorBrush x:Key="ErrorColor" Color="#EF4444"/>
        <SolidColorBrush x:Key="TextPrimary" Color="#1F2937"/>
        <SolidColorBrush x:Key="TextSecondary" Color="#6B7280"/>
        <SolidColorBrush x:Key="TextTertiary" Color="#9CA3AF"/>
        <SolidColorBrush x:Key="BackgroundLight" Color="#FFFFFF"/>
        <SolidColorBrush x:Key="BackgroundLighter" Color="#F9FAFB"/>
        <SolidColorBrush x:Key="BackgroundCard" Color="#FFFFFF"/>
        <SolidColorBrush x:Key="BorderColor" Color="#E5E7EB"/>
        <SolidColorBrush x:Key="BorderLightColor" Color="#F3F4F6"/>

        <!-- Gradient brushes -->
        <LinearGradientBrush x:Key="PrimaryGradient" StartPoint="0,0" EndPoint="1,1">
            <GradientStop Color="#10B981" Offset="0"/>
            <GradientStop Color="#059669" Offset="1"/>
        </LinearGradientBrush>

        <LinearGradientBrush x:Key="SecondaryGradient" StartPoint="0,0" EndPoint="1,1">
            <GradientStop Color="#3B82F6" Offset="0"/>
            <GradientStop Color="#2563EB" Offset="1"/>
        </LinearGradientBrush>

        <LinearGradientBrush x:Key="RedGradient" StartPoint="0,0" EndPoint="1,1">
            <GradientStop Color="#EF4444" Offset="0"/>
            <GradientStop Color="#DC2626" Offset="1"/>
        </LinearGradientBrush>

        <LinearGradientBrush x:Key="OrangeGradient" StartPoint="0,0" EndPoint="1,1">
            <GradientStop Color="#F59E0B" Offset="0"/>
            <GradientStop Color="#D97706" Offset="1"/>
        </LinearGradientBrush>

        <!-- Shadow effects -->
        <DropShadowEffect x:Key="CardShadow" Color="#000000" Opacity="0.08" ShadowDepth="0" BlurRadius="20" Direction="0"/>
        <DropShadowEffect x:Key="HoverShadow" Color="#000000" Opacity="0.12" ShadowDepth="0" BlurRadius="25" Direction="0"/>
        <DropShadowEffect x:Key="ButtonShadow" Color="#000000" Opacity="0.15" ShadowDepth="0" BlurRadius="10" Direction="0"/>

        <!-- Style cho nút hành động chính -->
        <Style TargetType="{x:Type Button}" x:Key="ModernPrimaryButton">
            <Setter Property="Background" Value="{StaticResource SecondaryGradient}"/>
            <Setter Property="Foreground" Value="White"/>
            <Setter Property="FontSize" Value="14"/>
            <Setter Property="FontWeight" Value="SemiBold"/>
            <Setter Property="BorderThickness" Value="0"/>
            <Setter Property="Cursor" Value="Hand"/>
            <Setter Property="Height" Value="42"/>
            <Setter Property="Padding" Value="24,0"/>
            <Setter Property="Effect" Value="{StaticResource ButtonShadow}"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="{x:Type Button}">
                        <Border x:Name="Border" 
                                CornerRadius="8"
                                Background="{TemplateBinding Background}">
                            <ContentPresenter HorizontalAlignment="Center"
                                              VerticalAlignment="Center"/>
                        </Border>
                        <ControlTemplate.Triggers>
                            <Trigger Property="IsMouseOver" Value="True">
                                <Setter TargetName="Border" Property="Background" Value="{StaticResource SecondaryDarkColor}"/>
                                <Setter Property="Effect" Value="{StaticResource HoverShadow}"/>
                            </Trigger>
                            <Trigger Property="IsPressed" Value="True">
                                <Setter TargetName="Border" Property="Background" Value="#1D4ED8"/>
                            </Trigger>
                        </ControlTemplate.Triggers>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>

        <!-- Style riêng cho nút Quét Ảnh -->
        <Style TargetType="{x:Type Button}" x:Key="ScanButtonStyle" BasedOn="{StaticResource ModernPrimaryButton}">
            <Setter Property="Background" Value="{StaticResource PrimaryGradient}"/>
            <Style.Triggers>
                <Trigger Property="IsMouseOver" Value="True">
                    <Setter Property="Background" Value="{StaticResource PrimaryDarkColor}"/>
                </Trigger>
            </Style.Triggers>
        </Style>

        <!-- Style cho ComboBox với bo góc giống button -->
        <Style TargetType="{x:Type ComboBox}" x:Key="ComboBoxStyle">
            <Setter Property="OverridesDefaultStyle" Value="True"/>
            <Setter Property="Background" Value="#FFFFFF"/>
            <Setter Property="Foreground" Value="#586A84"/>
            <Setter Property="BorderBrush" Value="#E8E8E8"/>
            <Setter Property="BorderThickness" Value="1"/>
            <Setter Property="FontSize" Value="14"/>
            <Setter Property="Padding" Value="10,0"/>
            <Setter Property="Height" Value="40"/>
            <Setter Property="VerticalContentAlignment" Value="Center"/>
            <Setter Property="Cursor" Value="Hand"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="{x:Type ComboBox}">
                        <Border x:Name="Border"
                                Background="{TemplateBinding Background}" 
                                BorderBrush="{TemplateBinding BorderBrush}" 
                                BorderThickness="{TemplateBinding BorderThickness}"
                                CornerRadius="6"
                                ClipToBounds="True">
                            <Grid>
                                <ToggleButton Name="ToggleButton" 
                                        Focusable="false" 
                                        IsChecked="{Binding Path=IsDropDownOpen, Mode=TwoWay, RelativeSource={RelativeSource TemplatedParent}}" 
                                        ClickMode="Press"
                                        Background="Transparent"
                                        BorderThickness="0"
                                        HorizontalAlignment="Stretch"
                                        VerticalAlignment="Stretch">
                                    <ToggleButton.Template>
                                        <ControlTemplate TargetType="ToggleButton">
                                            <Border Background="Transparent"
                                                    BorderThickness="0">
                                                <Path Name="Arrow" 
                                                        Fill="#586A84" 
                                                        HorizontalAlignment="Right" 
                                                        Margin="0,0,10,0" 
                                                        VerticalAlignment="Center" 
                                                        Data="M 0 0 L 4 4 L 8 0 Z"/>
                                            </Border>
                                        </ControlTemplate>
                                    </ToggleButton.Template>
                                </ToggleButton>
                                <ContentPresenter Name="ContentSite" 
                                        IsHitTestVisible="False" 
                                        Content="{TemplateBinding SelectionBoxItem}" 
                                        ContentTemplate="{TemplateBinding SelectionBoxItemTemplate}" 
                                        ContentTemplateSelector="{TemplateBinding ItemTemplateSelector}" 
                                        Margin="10,0,30,0" 
                                        VerticalAlignment="Center" 
                                        HorizontalAlignment="Left"/>
                                <TextBox x:Name="PART_EditableTextBox" 
                                        IsReadOnly="{TemplateBinding IsReadOnly}" 
                                        Background="{TemplateBinding Background}" 
                                        BorderThickness="0" 
                                        Margin="10,0,30,0" 
                                        Padding="0" 
                                        VerticalAlignment="Center" 
                                        HorizontalAlignment="Left" 
                                        Focusable="True" 
                                        Visibility="Hidden"/>
                                <Popup Name="Popup" 
                                        Placement="Bottom" 
                                        IsOpen="{TemplateBinding IsDropDownOpen}" 
                                        AllowsTransparency="True" 
                                        Focusable="False" 
                                        PopupAnimation="Slide">
                                    <Grid Name="DropDown" 
                                            SnapsToDevicePixels="True" 
                                            MinWidth="{TemplateBinding ActualWidth}" 
                                            MaxHeight="{TemplateBinding MaxDropDownHeight}">
                                        <Border x:Name="DropDownBorder" 
                                                Background="White" 
                                                BorderThickness="1" 
                                                BorderBrush="#E8E8E8" 
                                                CornerRadius="6"
                                                Padding="4">
                                            <ScrollViewer Margin="0,2" 
                                                    SnapsToDevicePixels="True">
                                                <StackPanel IsItemsHost="True" 
                                                        KeyboardNavigation.DirectionalNavigation="Contained"/>
                                            </ScrollViewer>
                                        </Border>
                                    </Grid>
                                </Popup>
                            </Grid>
                        </Border>
                        <ControlTemplate.Triggers>
                            <Trigger Property="IsMouseOver" Value="True">
                                <Setter Property="Background" Value="#FAFAFA"/>
                            </Trigger>
                            <Trigger Property="IsDropDownOpen" Value="True">
                                <Setter Property="Background" Value="#FAFAFA"/>
                            </Trigger>
                        </ControlTemplate.Triggers>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>

        <!-- Style cho ComboBoxItem với bo góc và màu sắc đẹp -->
        <Style TargetType="{x:Type ComboBoxItem}">
            <Setter Property="Background" Value="White"/>
            <Setter Property="Foreground" Value="#586A84"/>
            <Setter Property="Padding" Value="12,10"/>
            <Setter Property="Margin" Value="2"/>
            <Setter Property="BorderThickness" Value="0"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="{x:Type ComboBoxItem}">
                        <Border x:Name="Bd" 
                                Background="{TemplateBinding Background}" 
                                BorderThickness="{TemplateBinding BorderThickness}"
                                CornerRadius="4"
                                Padding="{TemplateBinding Padding}">
                            <ContentPresenter HorizontalAlignment="{TemplateBinding HorizontalContentAlignment}" 
                                            VerticalAlignment="{TemplateBinding VerticalContentAlignment}"
                                            SnapsToDevicePixels="{TemplateBinding SnapsToDevicePixels}"/>
                        </Border>
                        <ControlTemplate.Triggers>
                            <Trigger Property="IsHighlighted" Value="True">
                                <Setter TargetName="Bd" Property="Background" Value="#F0F4F8"/>
                            </Trigger>
                            <Trigger Property="IsMouseOver" Value="True">
                                <Setter TargetName="Bd" Property="Background" Value="#F0F4F8"/>
                            </Trigger>
                        </ControlTemplate.Triggers>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>

        <!-- Style cho nút Segment hiện đại -->
        <Style TargetType="{x:Type Button}" x:Key="ModernSegmentButton">
            <Setter Property="Background" Value="Transparent"/>
            <Setter Property="Foreground" Value="{StaticResource TextSecondary}"/>
            <Setter Property="FontSize" Value="14"/>
            <Setter Property="FontWeight" Value="Medium"/>
            <Setter Property="BorderThickness" Value="0"/>
            <Setter Property="Cursor" Value="Hand"/>
            <Setter Property="Height" Value="38"/>
            <Setter Property="Padding" Value="20,0"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="{x:Type Button}">
                        <Border x:Name="Border" 
                                CornerRadius="8"
                                Background="{TemplateBinding Background}">
                            <ContentPresenter HorizontalAlignment="Center"
                                              VerticalAlignment="Center"/>
                        </Border>
                        <ControlTemplate.Triggers>
                            <Trigger Property="IsMouseOver" Value="True">
                                <Setter TargetName="Border" Property="Background" Value="#F3F4F6"/>
                                <Setter Property="Foreground" Value="{StaticResource TextPrimary}"/>
                            </Trigger>
                        </ControlTemplate.Triggers>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>

        <!-- Style cho nút Segment đang ACTIVE -->
        <Style TargetType="{x:Type Button}" x:Key="ModernActiveSegmentButton">
            <Setter Property="Background" Value="{StaticResource TextPrimary}"/>
            <Setter Property="Foreground" Value="White"/>
            <Setter Property="FontSize" Value="14"/>
            <Setter Property="FontWeight" Value="Medium"/>
            <Setter Property="BorderThickness" Value="0"/>
            <Setter Property="Cursor" Value="Hand"/>
            <Setter Property="Height" Value="38"/>
            <Setter Property="Padding" Value="20,0"/>
            <Setter Property="Effect" Value="{StaticResource ButtonShadow}"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="{x:Type Button}">
                        <Border x:Name="Border" 
                                CornerRadius="8"
                                Background="{TemplateBinding Background}">
                            <ContentPresenter HorizontalAlignment="Center"
                                              VerticalAlignment="Center"/>
                        </Border>
                        <ControlTemplate.Triggers>
                            <Trigger Property="IsMouseOver" Value="True">
                                <Setter TargetName="Border" Property="Background" Value="#374151"/>
                            </Trigger>
                        </ControlTemplate.Triggers>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>

        <!-- Style cải tiến cho ComboBox -->
        <Style TargetType="{x:Type ComboBox}" x:Key="ModernComboBox">
            <Setter Property="Background" Value="{StaticResource BackgroundLight}"/>
            <Setter Property="Foreground" Value="{StaticResource TextPrimary}"/>
            <Setter Property="BorderBrush" Value="{StaticResource BorderColor}"/>
            <Setter Property="BorderThickness" Value="1"/>
            <Setter Property="FontSize" Value="14"/>
            <Setter Property="Padding" Value="12,0"/>
            <Setter Property="Height" Value="40"/>
            <Setter Property="VerticalContentAlignment" Value="Center"/>
            <Setter Property="Cursor" Value="Hand"/>
            <Setter Property="Effect" Value="{StaticResource ButtonShadow}"/>
        </Style>

        <!-- Style cải tiến cho thẻ tài chính -->
        <Style TargetType="{x:Type Border}" x:Key="ModernFinanceCard">
            <Setter Property="Background" Value="{StaticResource BackgroundCard}"/>
            <Setter Property="CornerRadius" Value="12"/>
            <Setter Property="BorderThickness" Value="1"/>
            <Setter Property="BorderBrush" Value="{StaticResource BorderLightColor}"/>
            <Setter Property="Margin" Value="8"/>
            <Setter Property="Effect" Value="{StaticResource CardShadow}"/>
        </Style>

        <!-- Style cải tiến cho Search Box -->
        <Style TargetType="{x:Type TextBox}" x:Key="ModernSearchBox">
            <Setter Property="Background" Value="{StaticResource BackgroundLighter}"/>
            <Setter Property="Foreground" Value="{StaticResource TextPrimary}"/>
            <Setter Property="BorderBrush" Value="{StaticResource BorderColor}"/>
            <Setter Property="BorderThickness" Value="1"/>
            <Setter Property="FontSize" Value="14"/>
            <Setter Property="Padding" Value="12,10"/>
            <Setter Property="Height" Value="40"/>
            <Setter Property="VerticalContentAlignment" Value="Center"/>
            <Setter Property="Effect" Value="{StaticResource ButtonShadow}"/>
        </Style>

        <!-- Style cho statistic cards -->
        <Style TargetType="{x:Type Border}" x:Key="ModernStatCard">
            <Setter Property="Background" Value="{StaticResource BackgroundCard}"/>
            <Setter Property="CornerRadius" Value="12"/>
            <Setter Property="Padding" Value="24"/>
            <Setter Property="BorderThickness" Value="1"/>
            <Setter Property="BorderBrush" Value="{StaticResource BorderLightColor}"/>
            <Setter Property="Effect" Value="{StaticResource CardShadow}"/>
        </Style>

        <!-- Style cho section headers -->
        <Style TargetType="{x:Type TextBlock}" x:Key="ModernSectionHeader">
            <Setter Property="Foreground" Value="{StaticResource TextPrimary}"/>
            <Setter Property="FontSize" Value="26"/>
            <Setter Property="FontWeight" Value="Bold"/>
            <Setter Property="Margin" Value="0,0,0,24"/>
        </Style>

        <!-- Style cho pagination -->
        <Style TargetType="{x:Type Border}" x:Key="ModernPaginationContainer">
            <Setter Property="Background" Value="{StaticResource BackgroundLighter}"/>
            <Setter Property="CornerRadius" Value="10"/>
            <Setter Property="Padding" Value="20,16"/>
            <Setter Property="BorderThickness" Value="1"/>
            <Setter Property="BorderBrush" Value="{StaticResource BorderLightColor}"/>
            <Setter Property="Effect" Value="{StaticResource CardShadow}"/>
        </Style>

        <!-- Style cho progress bar hiện đại -->
        <Style TargetType="{x:Type ProgressBar}" x:Key="ModernProgressBar">
            <Setter Property="Height" Value="6"/>
            <Setter Property="BorderThickness" Value="0"/>
            <Setter Property="Background" Value="#F3F4F6"/>
            <Setter Property="Foreground" Value="{StaticResource SecondaryColor}"/>
        </Style>

    </Window.Resources>

    <Grid Background="{StaticResource BackgroundLighter}">
        <Grid.ColumnDefinitions>
            <ColumnDefinition Width="269" MinWidth="250"/>
            <ColumnDefinition/>
        </Grid.ColumnDefinitions>

        <!-- === SIDEBAR CONTROL === -->
        <components:SidebarControl Grid.Column="0" x:Name="SidebarControl"/>

        <!-- === KHU VỰC NỘI DUNG CHÍNH === -->
        <Grid Margin="223,15,15,15" Grid.ColumnSpan="2">
            <Grid.RowDefinitions>
                <RowDefinition Height="80"/>
                <RowDefinition Height="*"/>
            </Grid.RowDefinitions>

            <!-- Top Bar Control -->
            <components:TopbarControl Grid.Row="0" x:Name="TopbarControl"/>

            <!-- Main Content Area -->
            <ScrollViewer Grid.Row="1"
                    VerticalScrollBarVisibility="Auto"
                    HorizontalScrollBarVisibility="Disabled">
                <StackPanel>
                    <!-- Header: Title -->
                    <TextBlock Text="Quản lý tài chính"
                               Foreground="#3B4758"
                            FontSize="24"
                            FontWeight="Bold"
                               Margin="20,15,0,20"/>

                    <!-- THANH CHUYỂN VIEW (TABS) -->
                    <Border Background="White" CornerRadius="10" Padding="4" Margin="0,0,0,20"
                            BorderThickness="1" BorderBrush="{StaticResource BorderColor}">
                        <StackPanel Orientation="Horizontal">
                            <Button Content="Tất cả bản ghi" 
                                    x:Name="ViewAllRecordsButton"
                                    Click="ViewAllRecords_Click"
                                    Style="{StaticResource ModernActiveSegmentButton}"/>
                            <Button Content="Quản lý công nợ" 
                                    x:Name="ViewDebtsButton"
                                    Click="ViewDebts_Click"
                                    Style="{StaticResource ModernSegmentButton}"/>
                            <Button Content="Báo cáo thu chi" 
                                    x:Name="ViewReportsButton"
                                    Click="ViewReports_Click"
                                    Style="{StaticResource ModernSegmentButton}"/>
                        </StackPanel>
                    </Border>


                    <!-- THANH HÀNH ĐỘNG TRÊN CÙNG -->
                    <Border Background="#FFFFFF"
                            CornerRadius="8"
                            Padding="15"
                            Margin="0,0,0,20">
                        <Grid>
                            <StackPanel Orientation="Horizontal" HorizontalAlignment="Left">
                                <Button Content="Đồng bộ G.Form"
                                    Style="{StaticResource ScanButtonStyle}"
                                    Command="{Binding ProcessDebtsFromGoogleFormCommand}"
                                    Width="140"/>

                                <Button Content="Nhập tay"
                                    Style="{StaticResource ModernPrimaryButton}" 
                                    Click="ManualInputButton_Click" 
                                    Width="120"
                                    Margin="10,0,0,0"/>
                            </StackPanel>
                            <StackPanel Orientation="Horizontal"
                                    HorizontalAlignment="Right">
                                <Grid Width="250" Height="40">
                                    <Border Background="#FFFFFF" CornerRadius="4"/>
                                    <TextBlock Text="Tìm kiếm tài chính..." Foreground="#7D8FA9" FontSize="14" IsHitTestVisible="False" VerticalAlignment="Center" Margin="10,0,0,0">
                                        <TextBlock.Style>
                                            <Style TargetType="TextBlock">
                                                <Setter Property="Visibility" Value="Collapsed"/>
                                                <Style.Triggers>
                                                    <DataTrigger Binding="{Binding Text, ElementName=FinancialSearchTextBox}" Value="">
                                                        <Setter Property="Visibility" Value="Visible"/>
                                                    </DataTrigger>
                                                </Style.Triggers>
                                            </Style>
                                        </TextBlock.Style>
                                    </TextBlock>
                                    <TextBox x:Name="FinancialSearchTextBox"
                                             Background="Transparent"
                                             BorderThickness="0"
                                             VerticalContentAlignment="Center"
                                             Margin="10,0,10,0"
                                             Text="{Binding SearchText, UpdateSourceTrigger=PropertyChanged}"/>
                                </Grid>
                                <ComboBox Width="190"
                                        Style="{StaticResource ComboBoxStyle}"
                                        Margin="10,0,0,0">
                                    <ComboBoxItem IsSelected="True">Mới nhất</ComboBoxItem>
                                    <ComboBoxItem>Cũ nhất</ComboBoxItem>
                                </ComboBox>
                            </StackPanel>
                        </Grid>
                    </Border>

                    <!-- MAIN CONTENT AREA HIỆN ĐẠI -->
                    <Grid Grid.Row="1">
                        <!-- Loading Indicator hiện đại -->
                        <Border Background="{StaticResource BackgroundCard}" 
                        CornerRadius="12"
                        Padding="32"
                        VerticalAlignment="Center"
                        HorizontalAlignment="Center"
                        Visibility="{Binding IsLoading, Converter={StaticResource BooleanToVisibilityConverter}}"
                        BorderThickness="1"
                        BorderBrush="{StaticResource BorderLightColor}"
                        Effect="{StaticResource CardShadow}">
                            <StackPanel Orientation="Horizontal" VerticalAlignment="Center">
                                <ProgressBar IsIndeterminate="True" 
                                     Width="24" 
                                     Height="24" 
                                     Margin="0,0,16,0"
                                     Foreground="{StaticResource SecondaryColor}"
                                     Style="{StaticResource ModernProgressBar}"/>
                                <TextBlock Text="Đang tải dữ liệu..." 
                                  FontSize="15" 
                                  Foreground="{StaticResource TextSecondary}" 
                                  VerticalAlignment="Center"
                                  FontWeight="Medium"/>
                            </StackPanel>
                        </Border>

                        <!-- === VIEW: TẤT CẢ BẢN GHI === -->
                        <ScrollViewer VerticalScrollBarVisibility="Auto"
                              HorizontalScrollBarVisibility="Disabled"
                              Visibility="{Binding IsAllRecordsView, Converter={StaticResource BooleanToVisibilityConverter}}"
                              Padding="2">
                            <StackPanel>
                                <!-- Danh sách bản ghi dạng lưới -->
                                <ItemsControl ItemsSource="{Binding FinancialRecords}" Margin="0,0,0,20">
                                    <ItemsControl.ItemsPanel>
                                        <ItemsPanelTemplate>
                                            <WrapPanel Orientation="Horizontal"/>
                                        </ItemsPanelTemplate>
                                    </ItemsControl.ItemsPanel>
                                    <ItemsControl.ItemTemplate>
                                        <DataTemplate>
                                            <Border Style="{StaticResource ModernFinanceCard}"
                                            Width="340"
                                            MouseEnter="Card_MouseEnter"
                                            MouseLeave="Card_MouseLeave"
                                            Tag="{Binding DataContext, RelativeSource={RelativeSource AncestorType=Window}}"
                                            Cursor="Hand">
                                                <Border.ContextMenu>
                                                    <ContextMenu>
                                                        <MenuItem Header="Xem chi tiết" 
                                                          Command="{Binding PlacementTarget.Tag.ViewDetailCommand, RelativeSource={RelativeSource AncestorType=ContextMenu}}"
                                                          CommandParameter="{Binding PlacementTarget.DataContext, RelativeSource={RelativeSource AncestorType=ContextMenu}}"/>
                                                        <MenuItem Header="Đánh dấu đã trả" 
                                                          Command="{Binding PlacementTarget.Tag.MarkAsPaidCommand, RelativeSource={RelativeSource AncestorType=ContextMenu}}"
                                                          CommandParameter="{Binding PlacementTarget.DataContext, RelativeSource={RelativeSource AncestorType=ContextMenu}}"/>
                                                        <Separator/>
                                                        <MenuItem Header="Chỉnh sửa" 
                                                          Command="{Binding PlacementTarget.Tag.EditCommand, RelativeSource={RelativeSource AncestorType=ContextMenu}}"
                                                          CommandParameter="{Binding PlacementTarget.DataContext, RelativeSource={RelativeSource AncestorType=ContextMenu}}"/>
                                                        <MenuItem Header="Xóa" 
                                                          Command="{Binding PlacementTarget.Tag.DeleteCommand, RelativeSource={RelativeSource AncestorType=ContextMenu}}"
                                                          CommandParameter="{Binding PlacementTarget.DataContext, RelativeSource={RelativeSource AncestorType=ContextMenu}}"
                                                          Foreground="{StaticResource ErrorColor}"/>
                                                    </ContextMenu>
                                                </Border.ContextMenu>

                                                <StackPanel>
                                                    <!-- Card Header -->
                                                    <Border Background="{StaticResource BackgroundLighter}"
                                                    Padding="20,16"
                                                    CornerRadius="12,12,0,0"
                                                    BorderThickness="0,0,0,1"
                                                    BorderBrush="{StaticResource BorderLightColor}">
                                                        <Grid>
                                                            <Grid.ColumnDefinitions>
                                                                <ColumnDefinition Width="*"/>
                                                                <ColumnDefinition Width="Auto"/>
                                                            </Grid.ColumnDefinitions>

                                                            <StackPanel Grid.Column="0">
                                                                <TextBlock Text="{Binding TenPhong}"
                                                                  FontWeight="Bold"
                                                                  FontSize="16"
                                                                  Foreground="{StaticResource TextPrimary}"/>
                                                                <TextBlock Text="{Binding KyHan, StringFormat='Kỳ: {0:MMM yyyy}'}"
                                                                  FontSize="13"
                                                                  Foreground="{StaticResource TextTertiary}"
                                                                  Margin="0,4,0,0"/>
                                                            </StackPanel>

                                                            <Border Grid.Column="1"
                                                            Background="{StaticResource BackgroundLighter}"
                                                            CornerRadius="6"
                                                            Padding="8,4"
                                                            HorizontalAlignment="Right"
                                                            VerticalAlignment="Center"
                                                            BorderThickness="1"
                                                            BorderBrush="{StaticResource BorderColor}"
                                                            Effect="{StaticResource ButtonShadow}">
                                                                <TextBlock Text="{Binding LoaiGiaoDich}"
                                                                  FontSize="12"
                                                                  Foreground="{StaticResource TextSecondary}"
                                                                  FontWeight="Medium"/>
                                                            </Border>
                                                        </Grid>
                                                    </Border>

                                                    <!-- Card Content -->
                                                    <StackPanel Margin="20" Grid.IsSharedSizeScope="True">
                                                        <!-- Thông tin chính -->
                                                        <Grid Margin="0,0,0,16">
                                                            <Grid.RowDefinitions>
                                                                <RowDefinition Height="Auto"/>
                                                                <RowDefinition Height="Auto"/>
                                                            </Grid.RowDefinitions>

                                                            <!-- Số tiền -->
                                                            <StackPanel Grid.Row="0" Orientation="Horizontal" 
                                                               Margin="0,0,0,12">
                                                                <TextBlock Text="Số tiền:" 
                                                                  Foreground="{StaticResource TextSecondary}" 
                                                                  FontSize="14"
                                                                  Margin="0,0,8,0"/>
                                                                <TextBlock Text="{Binding TongTien, StringFormat='{}{0:N0} VNĐ'}"
                                                                  FontWeight="Bold"
                                                                  FontSize="16"
                                                                  Foreground="{StaticResource TextPrimary}"/>
                                                            </StackPanel>

                                                            <!-- Chi tiết và Trạng thái -->
                                                            <Grid Grid.Row="1">
                                                                <Grid.ColumnDefinitions>
                                                                    <ColumnDefinition Width="*" SharedSizeGroup="DetailColumn"/>
                                                                    <ColumnDefinition Width="*" SharedSizeGroup="StatusColumn"/>
                                                                </Grid.ColumnDefinitions>

                                                                <StackPanel Grid.Column="0">
                                                                    <TextBlock Text="Chi tiết" 
                                                                      Foreground="{StaticResource TextTertiary}" 
                                                                      FontSize="12"
                                                                      FontWeight="Medium"/>
                                                                    <TextBlock Text="{Binding ChiTietGiaoDich}"
                                                                      FontSize="14"
                                                                      Foreground="{StaticResource TextPrimary}"
                                                                      Margin="0,4,0,0"
                                                                      TextTrimming="CharacterEllipsis"/>
                                                                </StackPanel>

                                                                <StackPanel Grid.Column="1" Margin="12,0,0,0">
                                                                    <TextBlock Text="Trạng thái" 
                                                                      Foreground="{StaticResource TextTertiary}" 
                                                                      FontSize="12"
                                                                      FontWeight="Medium"/>
                                                                    <TextBlock Text="{Binding TrangThaiText}"
                                                                      FontSize="14"
                                                                      FontWeight="SemiBold"
                                                                      Foreground="{Binding TrangThaiColor}"
                                                                      Margin="0,4,0,0"/>
                                                                </StackPanel>
                                                            </Grid>
                                                        </Grid>

                                                        <!-- Progress Section -->
                                                        <StackPanel>
                                                            <Grid Margin="0,0,0,8">
                                                                <TextBlock Text="Tiến độ" 
                                                                  Foreground="{StaticResource TextSecondary}" 
                                                                  FontSize="12"
                                                                  FontWeight="Medium"/>
                                                                <TextBlock Text="{Binding ProgressValue, StringFormat='{}{0}%'}"
                                                                  Foreground="{StaticResource TextSecondary}" 
                                                                  FontSize="12"
                                                                  HorizontalAlignment="Right"/>
                                                            </Grid>

                                                            <ProgressBar Style="{StaticResource ModernProgressBar}"
                                                                Value="{Binding ProgressValue}"
                                                                Margin="0,0,0,12"
                                                                Minimum="0"
                                                                Maximum="100"/>

                                                            <TextBlock Text="Xem chi tiết" 
                                                              Foreground="{StaticResource SecondaryColor}" 
                                                              FontSize="14"
                                                              FontWeight="Medium"
                                                              HorizontalAlignment="Right"
                                                              Cursor="Hand"
                                                              MouseLeftButtonDown="ViewDetail_MouseLeftButtonDown"/>
                                                        </StackPanel>
                                                    </StackPanel>
                                                </StackPanel>
                                            </Border>
                                        </DataTemplate>
                                    </ItemsControl.ItemTemplate>
                                </ItemsControl>

                                <!-- Pagination hiện đại -->
                                <Border Style="{StaticResource ModernPaginationContainer}">
                                    <Grid>
                                        <TextBlock Text="{Binding PageInfo}"
                                          VerticalAlignment="Center"
                                          HorizontalAlignment="Left"
                                          Foreground="{StaticResource TextSecondary}"
                                          FontSize="14"
                                          FontWeight="Medium"/>
                                        <StackPanel Orientation="Horizontal" HorizontalAlignment="Right">
                                            <Button Content="&lt; Trước" 
                                            Style="{StaticResource ModernSegmentButton}" 
                                            Margin="0,0,8,0" 
                                            Height="36" 
                                            Padding="16,0"
                                            Command="{Binding PreviousPageCommand}"
                                            IsEnabled="{Binding CanGoToPreviousPage}"/>

                                            <StackPanel Orientation="Horizontal">
                                                <ItemsControl ItemsSource="{Binding PageNumbers}">
                                                    <ItemsControl.ItemsPanel>
                                                        <ItemsPanelTemplate>
                                                            <StackPanel Orientation="Horizontal"/>
                                                        </ItemsPanelTemplate>
                                                    </ItemsControl.ItemsPanel>
                                                    <ItemsControl.ItemTemplate>
                                                        <DataTemplate>
                                                            <Button Content="{Binding}" 
                                                            Margin="4,0,0,0" 
                                                            Height="36" 
                                                            Width="36" 
                                                            Padding="0"
                                                            Click="PageNumber_Click"
                                                            CommandParameter="{Binding}">
                                                                <Button.Style>
                                                                    <Style TargetType="Button" BasedOn="{StaticResource ModernSegmentButton}">
                                                                        <Setter Property="Background" Value="Transparent"/>
                                                                        <Setter Property="Foreground" Value="{StaticResource TextSecondary}"/>
                                                                        <Style.Triggers>
                                                                            <!-- FIX: Sử dụng MultiBinding DataTrigger đã sửa -->
                                                                            <DataTrigger Value="True">
                                                                                <DataTrigger.Binding>
                                                                                    <MultiBinding Converter="{StaticResource PageNumberEqualsMultiConverter}">
                                                                                        <Binding RelativeSource="{RelativeSource AncestorType=Window}" Path="DataContext.CurrentPage" />
                                                                                        <Binding />
                                                                                    </MultiBinding>
                                                                                </DataTrigger.Binding>
                                                                                <Setter Property="Background" Value="{StaticResource TextPrimary}"/>
                                                                                <Setter Property="Foreground" Value="White"/>
                                                                                <Setter Property="Effect" Value="{StaticResource ButtonShadow}"/>
                                                                            </DataTrigger>
                                                                        </Style.Triggers>
                                                                    </Style>
                                                                </Button.Style>
                                                            </Button>
                                                        </DataTemplate>
                                                    </ItemsControl.ItemTemplate>
                                                </ItemsControl>
                                            </StackPanel>

                                            <Button Content="Sau &gt;" 
                                            Style="{StaticResource ModernSegmentButton}" 
                                            Margin="8,0,0,0" 
                                            Height="36" 
                                            Padding="16,0"
                                            Command="{Binding NextPageCommand}"
                                            IsEnabled="{Binding CanGoToNextPage}"/>
                                        </StackPanel>
                                    </Grid>
                                </Border>
                            </StackPanel>
                        </ScrollViewer>

                        <!-- Các view khác giữ nguyên logic nhưng áp dụng style mới -->
                        <!-- === VIEW: QUẢN LÝ CÔNG NỢ === -->
                        <ScrollViewer VerticalScrollBarVisibility="Auto"
                              HorizontalScrollBarVisibility="Disabled"
                              Visibility="{Binding IsDebtsView, Converter={StaticResource BooleanToVisibilityConverter}}">
                            <StackPanel>
                                <Border Style="{StaticResource ModernStatCard}" Margin="0,0,0,10">
                                    <StackPanel>
                                        <TextBlock Text="Danh sách công nợ" 
                                          FontSize="20" 
                                          FontWeight="Bold" 
                                          Foreground="{StaticResource TextPrimary}" 
                                          Margin="0,0,0,20"/>
                                        <!-- DataGrid content giữ nguyên logic -->
                                        <DataGrid ItemsSource="{Binding Debts}"
                                                  AutoGenerateColumns="False"
                                                  CanUserAddRows="False"
                                                  Background="White"
                                                  BorderThickness="0"
                                                  GridLinesVisibility="Horizontal"
                                                  HeadersVisibility="Column"
                                                  RowHeight="50"
                                                  HorizontalAlignment="Stretch">

                                            <DataGrid.RowStyle>
                                                <Style TargetType="DataGridRow">
                                                    <!--
                                                        UPDATE: Thêm EventSetter để xử lý DoubleClick
                                                        Handler="DataGridRow_MouseDoubleClick" sẽ trỏ tới file .xaml.cs
                                                    -->
                                                    <EventSetter Event="MouseDoubleClick" Handler="DataGridRow_MouseDoubleClick" />

                                                    <Style.Triggers>
                                                        <DataTrigger Binding="{Binding TrangThaiThanhToan}" Value="Cảnh báo">
                                                            <Setter Property="Background" Value="#FFF7ED"/>
                                                            <Setter Property="BorderBrush" Value="#F97316"/>
                                                            <Setter Property="BorderThickness" Value="1"/>
                                                            <Setter Property="ToolTip" Value="Có sự sai lệch giữa ảnh và số nhập tay. Vui lòng kiểm tra!"/>
                                                        </DataTrigger>
                                                    </Style.Triggers>
                                                </Style>
                                            </DataGrid.RowStyle>

                                            <DataGrid.Columns>
                                                <DataGridTextColumn Header="Phòng" Binding="{Binding TenPhong}" Width="80" FontWeight="Bold"/>

                                                <DataGridTextColumn Header="Số liệu (Nhập | Ảnh)" Binding="{Binding ComparisonInfo}" Width="180"/>

                                                <DataGridTemplateColumn Header="Ghi chú hệ thống" Width="*">
                                                    <DataGridTemplateColumn.CellTemplate>
                                                        <DataTemplate>
                                                            <TextBlock Text="{Binding DiaChi}" 
                                                                       TextWrapping="Wrap" 
                                                                       VerticalAlignment="Center">
                                                                <TextBlock.Style>
                                                                    <Style TargetType="TextBlock">
                                                                        <Setter Property="Foreground" Value="#6B7280"/>
                                                                        <Style.Triggers>
                                                                            <DataTrigger Binding="{Binding TrangThaiThanhToan}" Value="Cảnh báo">
                                                                                <Setter Property="Foreground" Value="#EF4444"/>
                                                                                <Setter Property="FontWeight" Value="Bold"/>
                                                                            </DataTrigger>
                                                                        </Style.Triggers>
                                                                    </Style>
                                                                </TextBlock.Style>
                                                            </TextBlock>
                                                        </DataTemplate>
                                                    </DataGridTemplateColumn.CellTemplate>
                                                </DataGridTemplateColumn>

                                                <DataGridTextColumn Header="Tổng tiền dự kiến" Binding="{Binding TongTien, StringFormat='{}{0:N0} VNĐ'}" Width="140" FontWeight="Bold"/>

                                                <DataGridTemplateColumn Header="Trạng thái" Width="120">
                                                    <DataGridTemplateColumn.CellTemplate>
                                                        <DataTemplate>
                                                            <Border CornerRadius="12" Padding="10,4" HorizontalAlignment="Center">
                                                                <Border.Style>
                                                                    <Style TargetType="Border">
                                                                        <Setter Property="Background" Value="#E5E7EB"/>
                                                                        <Style.Triggers>
                                                                            <DataTrigger Binding="{Binding TrangThaiThanhToan}" Value="Cảnh báo">
                                                                                <Setter Property="Background" Value="#FEE2E2"/>
                                                                            </DataTrigger>
                                                                            <DataTrigger Binding="{Binding TrangThaiThanhToan}" Value="Chờ duyệt">
                                                                                <Setter Property="Background" Value="#D1FAE5"/>
                                                                            </DataTrigger>
                                                                            <!-- Thêm style cho trạng thái đã xác nhận -->
                                                                            <DataTrigger Binding="{Binding TrangThaiThanhToan}" Value="Đã xác nhận">
                                                                                <Setter Property="Background" Value="#DBEAFE"/>
                                                                            </DataTrigger>
                                                                        </Style.Triggers>
                                                                    </Style>
                                                                </Border.Style>
                                                                <TextBlock Text="{Binding TrangThaiThanhToan}" FontWeight="SemiBold">
                                                                    <TextBlock.Style>
                                                                        <Style TargetType="TextBlock">
                                                                            <Setter Property="Foreground" Value="#374151"/>
                                                                            <Style.Triggers>
                                                                                <DataTrigger Binding="{Binding TrangThaiThanhToan}" Value="Cảnh báo">
                                                                                    <Setter Property="Foreground" Value="#DC2626"/>
                                                                                </DataTrigger>
                                                                                <DataTrigger Binding="{Binding TrangThaiThanhToan}" Value="Chờ duyệt">
                                                                                    <Setter Property="Foreground" Value="#059669"/>
                                                                                </DataTrigger>
                                                                                <!-- Thêm style cho trạng thái đã xác nhận -->
                                                                                <DataTrigger Binding="{Binding TrangThaiThanhToan}" Value="Đã xác nhận">
                                                                                    <Setter Property="Foreground" Value="#1D4ED8"/>
                                                                                </DataTrigger>
                                                                            </Style.Triggers>
                                                                        </Style>
                                                                    </TextBlock.Style>
                                                                </TextBlock>
                                                            </Border>
                                                        </DataTemplate>
                                                    </DataGridTemplateColumn.CellTemplate>
                                                </DataGridTemplateColumn>

                                                <DataGridTemplateColumn Width="80">
                                                    <DataGridTemplateColumn.CellTemplate>
                                                        <DataTemplate>
                                                            <!-- 
                                                                Nút "Sửa" này đã được trỏ đúng
                                                                vào 'InspectDiscrepancyCommand' ở lượt trước.
                                                            -->
                                                            <Button Content="Sửa" 
                                                                    Command="{Binding DataContext.InspectDiscrepancyCommand, RelativeSource={RelativeSource AncestorType=Window}}" 
                                                                    CommandParameter="{Binding}"
                                                                    Style="{StaticResource ModernSegmentButton}"
                                                                    Padding="10,0" Height="30" FontSize="12"/>
                                                        </DataTemplate>
                                                    </DataGridTemplateColumn.CellTemplate>
                                                </DataGridTemplateColumn>

                                            </DataGrid.Columns>
                                        </DataGrid>
                                    </StackPanel>
                                </Border>
                            </StackPanel>
                        </ScrollViewer>

                        <!-- === VIEW: BÁO CÁO THU CHI === -->
                        <ScrollViewer VerticalScrollBarVisibility="Auto"
                              HorizontalScrollBarVisibility="Disabled"
                              Visibility="{Binding IsReportsView, Converter={StaticResource BooleanToVisibilityConverter}}">
                            <StackPanel>
                                <Border Style="{StaticResource ModernStatCard}" Margin="0,0,0,10">
                                    <StackPanel>
                                        <TextBlock Text="Báo cáo tài chính" 
                                          FontSize="20" 
                                          FontWeight="Bold" 
                                          Foreground="{StaticResource TextPrimary}" 
                                          Margin="0,0,0,16"/>
                                        <TextBlock Text="Thống kê theo tháng" 
                                          FontSize="15" 
                                          FontWeight="SemiBold" 
                                          Foreground="{StaticResource TextSecondary}" 
                                          Margin="0,0,0,12"/>
                                        <TextBlock Text="Dữ liệu thống kê sẽ được hiển thị tại đây" 
                                          Foreground="{StaticResource TextTertiary}" 
                                          FontSize="14"
                                          FontStyle="Italic"/>
                                    </StackPanel>
                                </Border>
                            </StackPanel>
                        </ScrollViewer>
                    </Grid>
                </StackPanel>
                <!-- Đóng StackPanel chính (từ dòng 344) -->
            </ScrollViewer>
            <!-- Đóng ScrollViewer chính (từ dòng 341) -->
        </Grid>
    </Grid>
</Window>